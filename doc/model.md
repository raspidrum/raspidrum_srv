

# Виды моделей

Модели разделяются на два класса:
 - мета описание
 - настройки

##  Мета описание

Служит для описания сущностей. На основе описания рисуется UI.

## Настройки

Служит для хранения и управления настройками семплера, микшера, китов и пр.


# Киты

Кит - набор семплов барабанной установки. Опционально может включать дополнительные слои (layer) для инструментов, например, OH (overhead), top и bottom для snare.

Fx - эффект. Может содержать цепочку эффектов, к-е обрабатывают звук последовательно.

Канал - обобщающая сущность, отвечающая для воспроизведение нескольких инструментов или нескольких слоев одного инструмента.

В ките настраивается:
 - название
 - движок (sfz, sf2, gig и пр.) - опционально
 - набор инструментов. Каждый содержит:
  - набор слоев (слоев может не быть, что означает только один основной слой)
    - в каждом слое набор семплов
    - значения по умолчанию:
      - уровень
      - панорама
  - возможность тюнинга:
      - pitch - может быть только для всех слоев инструмента сразу, иначе получится "каша"
      - ??? (eq, reverb - некторые движки и семплеры поддерживают)

# Пресеты

Для использования кита необходим пресет.
В пресете настраивается:
 - название
 - распределение инструментов кита по каналам. Каждый канал содержит:
   - уровень (см. Примечание 3)
   - панораму (см. Примечание 3)
   - цепочка fx для канала (см. Примечание 2 ниже)
 - в одном канале может быть несколько инструментов
   - для SFZ для каждого инструмента может быть свой tune (pitch, возможно eq, reverb и пр.) и volume и pan
   - для GIG возможны настройки для каждого сэмпла, но только в редакторе, а через API нельзя. Т.о. для каждого инструмента отдельный tune невозможен
   - для SF2 - хз
 - слои инструмента
   - список слоев
   - уровень каждого слоя
   - ~~панорама~~
   - цепочка fx для слоя ~~(если канал содержит более одного слоя инструмента. см. Примечание 2 ниже)~~
 - настройки инструмента (например, Pitch)
 - каналы микшера. Для каждого канала:
   - уровень
   - панорама
   - маршрутизация (в какую пару каналов звуковой карты выводить, если пар больше одной)
 - глобальный канал - канал после микшера и маршрутизации. Кол-во определяется кол-вом пар каналов звуковой карты
   - уровень
   - цепочка fx

  
Пресет привязывается к конкретному киту. Пресет не может быть использован для разных китов, т.к. в одном ките может быть несколько слоев инструмента, а в другом ките может вообще не быть слоев. Также, кит могут быть в различных форматах (SFZ, SF2, GIG) и использовать различные движки (fluidsynth, linuzsampler и пр.)


Примечание 2: 
- ~~В LinuxSampler каждый слой загружается в отдельный канал семплера. Т.к. fx в семплере настраивается для только для канала, то при наличии нескольких слоев у инструмента возможна настройка только fx для каждого канала. Общий fx на весь инструмент настроить нет возможности, т.к. в семплере отсутствует объединяющий слои канал. Возможно, такое можно реализовать путем запуска отдельных семплеров для каждого интструмента (например, в FluidSynth). Если же канал содержит только один основной слой инструмента, то слой фактически и есть канал.~~

- формат sfz предусматривает управление pitch, volume, pan для каждой группы (группа - в терминах sfz, может содержать семплы инструмента или слоя. в sfz нет разделения на инструменты и слои - они являются равнозначными. Разделение логическое вне sfz). Управление выполняется путем задания opcode *onCC с указанием номера канала MIDI CC, по которому выполняется регулирование. Данные opcode поддерживают LinuxSampler, sfizz, liquidsfz, возможно fluidsynth.


*Примечание 3: Если канал содержит несколько инструментов со слоями, то общей регулировки (например, volume или pan) для всех слоев одного инструмента нет. В таком случае при регулировке уровня или панорамы канала в целом математически пересчитывается уровень и панорама каждого слоя. Данный пересчет выполняется только на бэке и не виден в UI. Например, инструмент содержит два слоя. Слой 1 имеет уровень 80%, а слой 2 - уровень 60%. Если общий уровень инструмента выставить в 50%, то значения midi CC будут иметь значения 40% и 30% соответственно (% нужно пересчитать в абсолютные значения MIDI протокола). Но в UI уровни слоев будут отображаться также: 80% и 60%.*


### Возможные варианты конфигурации пресетов LinuxSampler

Семплер не имеет сущности "инструмент" и "слой", а только канал.
Настройки уровня может выполняться как для канала в целом (через АПИ), так и для отдельной группы sfz ( через MIDI CC).
Также возможно управлять volume, pan и даже reverb для канала в целом через MIDI CC путем добавления effect send к канала. https://bb.linuxsampler.org/viewtopic.php?t=181
Настройка fx может выполняться только в рамках канала. TODO: Часть fx, например, параметрический эквалайзер, может настраиваться для sfz-группы через MIDI CC. Но для этого необходимо установить LADSPA плагин.
Для SFZ pitch может настраиваться индивидуально для sfz-группы путем отправки MIDI CC.

#### Вариант 1 - Все инструменты вместе
В пресете только один канал.
Канал - реальный канал семплера.
В канале перечислены все инструменты. 
Регулировка канала - это регулировка всего кита. volume необходимо регулировать только в канале семплера или только глобально в семплере или только к микшере.
pan регулируется для канала путем добавления effect send. Либо в микшере.

<details>
  <summary>Варианты настройки</summary>

Вариант 1.1 (продвинутый SFZ):
  - глобально:
    - volume на макс
  - канал: 
    - volume - через API семплера
    - pan, tune и fx - через effect send
  - инструмент/слой:
    - gain, pan, tune - через MIDI CC
      - если инструмент из нескольких слоев, то gain и pan виртуальный
    - fx - нет
  
</details>
<br>

#### Вариант 2 - Инструменты в разных каналах

**Могут быть ограничения по кол-ву каналов**.

Каждый канал - реальный канал семплера и группа инструментов.
Инструменты со слоями (если есть) могут загружаться в отдельные каналы или несколько инструментов (даже со слоями) в один канал.
Если в канале несколько инструментов - то канал = группа инструментов. Требуется регулировка уровня для группы каналов.
Если в канал загружен только один инструмент, то канал = инструмент. В этом случае регулировка уровня инструмента через уровень канала.
Если у инструментов есть слои, то все они загружаются в один канал семплера.

<details>
  <summary>Варианты настройки</summary>

Вариант 2.1 Один канал - один инструмент: (продвинутый SFZ)
  - глобально
    - volume - через API семплера
    - pan, tune и fx - через effect send
  - канал: 
    - volume - через API семплера
    - pan - нет 
    - fx - через effect send
  - инструмент:
    - gain - 0dB
    - pan - через MIDI CC
    - tune - через MIDI CC 
  - слой:
    - gain - через MIDI CC
  
  Примечание 1: При наличии слоев проще регулировать уровень всего инструмента через уровень канала.

  Примечание 2: tune (например, pitch) и pan регулируется для всего инструмента целиком.

  Примечание 3: если в канале только один инструмент, то регулировка gain через MIDI CC выглядит избыточно и будет только путать, поэтому выставляется в 0dB.

Вариант 2.2 Один канал - несколько инструментов: (продвинутый SFZ)
  - глобально
    - volume - через API семплера
    - pan, tune и fx - через effect send
  - канал:
    - volume - через API семплера
    - pan и fx - через effect send
  - инструмент:
    - gain - через MIDI CC если нет слоев, виртуально если есть слои
    - pan - через MIDI CC
    - tune - через MIDI CC 
  - слой:
    - gain - через MIDI CC

  Примечание 1: При наличии слоев уровнем канала нелья регулировать уровень инструмента, поэтому регулировка виртуальная с пересчетом на уровни слоев.

```yaml
channels:
- key: 1
  name: Kick
  level: 0.97
  pan: 0.0
  fxs: 
  - ...
  instruments:
  - key: kick
    name: Kick
    pan: 0.0
    tunes:
    - ...
- key: 2
  name: Toms
  level: 0.87
  pan: 0.1
  fxs:
  - ...
  instruments:
    - key: tom1
      name: Tom 1
      level: 0.8
      pan: 0.0
      tunes:
      - ...
    - key: tom2
      name: Tom 2
      level: 0.9
      pan: 0.1
      tunes:
      - ...
```

</details>
<br>

#### Вариант 3 - Слои инструмента в отдельные каналы
**Могут быть ограничения по кол-ву каналов**

В пресете кол-во каналов по кол-ву слоев инструментов.
Канал инструмента, содержащий слой, является виртуальным. Относится как один-ко-многим: один канал инструмента - много каналов семплера.
Каждый слой располагается в отдельном канале семплера.

- глобально:
  - volume - через API семплера
  - pan, tune и fx - через effect send
- канал: - отсутствует как сущность
- инструмент:
  - gain - виртуально
  - pan - виртуально
  - tune - через MIDI CC транслируется в каналы слоев
- слой (фактически канал семплера): 
  - gain - через MIDI CC
  - pan - через MIDI CC
  - tune - через MIDI CC
  - fx - через API семплера

Примечание: 
 - виртуальный канал пропорционально регулирует volume и pan каждого канала слоя
 - gain и pan инструмента пропорционально регулируют gain и pan всех слоев
 - если слой один, то либо скрывать его, перенося все настройки инструмент, либо gain и pan инструмента являются опциональными и регулируют пропорционально настройки слоя

<details>
  <summary>Варианты настройки</summary>

```yaml
channels:
- key: 1
  name: Kick
  level: 0.97
  pan: 0.0
  fxs: 
  - ...
  instruments:
  - key: kick
    name: Kick
    tunes:
    - ...
- key: 2
  name: Snare
  level: 0.9
  pan: 0.0
  instruments:
  - key: snare
    name: Snare
    tunes:
    - ...
    layers:
    - key: snare_top
      name: Top
      level: 0.7
      pan: 0.0
      fxs:
      - ...
    - key: snare_bottom
      name: Bottom
      level: 0.8
      pan: -0.05
      fxs:
      - ...
- key: 3
  name: crash
  level: 0.7
  pan: -0.15
  instruments:
  - key: crash
    name: Crash
    tunes:
    - ...
    layers:
    - key: crash_oh
      name: OH
      level: 0.9
      pan: 0.0
      fxs:
      - ...
- key: 4
  name: Toms
  level: 0.9
  pan: 0.0
  instruments:
  - key: tom1
    name: Tom1
    level: 0.8
    pan: 0.0
    tunes:
    - ...
    layers:
    - key: tom1_bottom
      name: Bottom
      level: 0.7
      pan: 0.0
      fxs:
      - ..
    - key: tom1_oh
      name: OH
      level: 0.9
      pan: 0.0
      fxs:
      - ..
  - key: tom3
    name: Floor Tom
    tunes:
    - ...
    layers:
      - key: tom3_oh
        name: OH
        level: 0.9
        pan: 0.4
        fxs:
        - ...
```

</details>
<br>

#### Вариант 4 - Смешанный
Для одних инструментов по варианту 2, для других по варианту 3.

#### fluidsynth (SF2)

#### sfizz (SFZ) 

Настройка fx выполняется только для каждого канала семплера с помощью LADSPA (не уверен, поддерживает ли это sfizz).
Формат SFZ не имеет сущности "инструмент" и "слой", а только группа семплов (region). Для одного инструмента может быть несколько групп (слоев).
Фактически настройки выполняются только для группы семплов (слоя).
У слоя настраивается volume, и, возможно pan, tune. Настройка volume через API, а pan и tune - через MIDI CC (следует проверить).

**Вариант 1 - Все инструменты вместе**
В пресете только один канал.
Канал - реальный канал сеплера.
В канале перечислены все инструменты. Если у 




Варианты:
- авторежимы: 
  - все в один канал (доступен при отсутствии слоев)
  - все в разные каналы
  - по группам - создает каналы:
    - KICK
    - SNARE
    - HH
    - CYMBALS (crash, ride и пр.)
    - TOMS




#### Ограничения 
1. в instrument.controls.volume|pan может отсутсововать midiCC, а в instrument.layers.controls.volume|pan midiCC обязателен.
2. если в канале несколько инструментов,  и у инструмента есть слои, то у инструмента должен быть instrument.controls.volume|pan
3. если в канале несколько инструментов, то у инструмента без слоев volume|pan обязательно должен быть с midiCC 


#### Отличия моделей в srv и UI

##### Preset
- `key`: в UI есть поле key, а в srv uuid (Uid)
  - **решение**: поле обязательное, но не используется
    - в srv использовать uuid и передавать его в значении key
- `description`: в srv нет description
  - **решение**: поле не обязательное, не используется
    - удалить из модели UI и перегенерить freezed
    - удалить из документации UI /doc/complete_class.mmd

##### Preset.Channel
- `type`: в srv нет type, т.к. в текущей реализации все каналы - это каналы семплера. Но в модели UI это каналы `instrument`. В UI модели также есть канал `sampler`, к-й явялется глобальным для всего семплера. Такой канал может быть только один. Канал `sampler` может содержать fx. Для linuxsampler, это наверно задаетсяс помощью FX_SEND.
  - решение:
    - генерить один канал типа `sampler`, содержащий глобальную громкость linuxsampler
      - DONE: можно ли в linuxsampler глобально регулировать pan? - нельзя
    - каждый канал srv выдавать в API с типом `instrument`

- `pan`, `level`: в UI расположены прямо в канале, а в srv расположены в controls. В srv `volume` может быть как в самом канале, так и в `instrument.controls`. `pan` же располагается только в `instrument.controls`. В одном канале srv может располагаться несколько инструментов как с одинаковым кодом midiCC для Pan, так и различным. Также в srv для инструмента может быть слой, в котором регулируется `volume` и `pan`
  - **решение**:
    - `level`:
      - переименовать в UI `level` в `volume`
      - если в канале несколько инструментов, то регулируется `channel.controls.volume`
        - *Примечание: отдельный инструмент регулируется через `instrument.controls.volume` при наличии*
      - если в канале один инструмент 
        - в инструменте есть `volume` c midiCC, то реулируется `instrument.controls.volume` через отправку команды MIDI CC
          - в UI регулировка указывается в канале, в инструменте не указывается
        - в инструменте нет `volume` или есть `volume` но без midiCC, то регулируется `channel.controls.volume`
          - в UI регулировка указывается в канале, в инструменте не указывается
    - `pan`: логика полностью аналогична `level`
  
- `fxs`: пока не реализовано в srv


##### Preset.Channel.Instrument
- `key`: отсутствует в srv, но в srv есть uid. Нельзя использовать srv.uid в качестве key, т.к. srv.uid - это uid используемого инструмента (семплов). Может быть кейс, например, использования одного инструмента (семплов) для tom1 и tom2 с разным pitch.
  - **решение**: 
    - вариант 1. Использовать midiKey в качестве key, т.к. midiKey должен быть уникальным в пресете (хотя такого ограничния явно нет)
    - **вариант 2.** Использовать PK из БД.
      - добавить поле Id в модель PresetInstrument
      - маппить PresetInstrument.Id на UI Instrument.key

- `pan`, `level`: в UI расположены прямо в инструменте, а в srv расположены в controls.
  - В канале один инструмент
      - В UI отсутствует `pan`, `level`. В этом случае регулировка выполняется в канале. Это не зависит от наличия `layers` у инструмента.
  - В канале несколько инструментов
    - В UI может отсутствовать `pan`, `level`, если у инструмента есть layers.
  - **решение**:
    - переименовать в UI `level` в `volume`
    - в канале один инструмент
      - в UI регулировка указывается в канале, в инструменте не указывается. Канал использует регулировку инструмента, а не свою 
    - в канале несколько инструментов
      - в UI регулировка указывается в `Instrument`, если она присутствует в `PresetInstrument`
      - в инструменте с `volume` без midiCC регулировка инструмента виртуальная - пересчитываются значения в слоях и отправляются команды MIDI CC в слоях. При этом в модели srv в слоях не меняется значение `volume` (в БД сохраняется изменение только `volume` инструмента). 
        *Примечание: при отсутствии midiCC у `volume` инструмента валидация в srv гарантирует наличие слоев*

- `pitch`, `decay` и прочие регулировки: в UI располагается в `Instrument.tunes`. В srv располагается в `PresetInstrument.Controls`.
  - **решение:** все `PresetInstrument.Controls` кроме `volume` и `pan` помещаются в `Instrument.tunes`.
  


##### Preset.Channel.Instrument.Layer
- `key`: Использовать ключ мапы модели srv PresetInstrument
  
- `pan`, `level`: В UI всегда присутствует, но по модели UI оба необязательны. В srv всегда присутствует только `volume`, может опционально присутствовать `pan`.
  - **решение**:
    - переименовать в UI `level` в `volume`
  
- `tunes`: в UI отсутствует, но в srv может присутствовать регулировки, отличные от `volume` и `pan`. Но по факту, сейчас содержит только `volume`.
  - решение: не формируем. Если в srv в layers есть controls, отличные от `volume` и `pan`, то игнорим их и пишем warning в log.
    - #DONE: подумать как выровнять модель, чтобы не пришлось писать warning
      - вариант 1. В srv валидировать типы controls для Layer: только `volume` и `pan`. Остальное может располагаться только в `fxs`, к-й реализовать отдельной моделью в srv.
      - **вариант 2**. Добавить в UI для layer `tunes`, куда помещать регулировки кроме `volume` и `pan`. Пока UI не поддерживает их будет игнорить
      - вариант 3. В srv явно разделить основные регулировки и прочие. В основные должны попасть только `volume` и `pan`, в прочие - все остальные.
  
- `fxs`: в srv не реализовано


## Map UI, srv and db fields for preset

| UI<br>Preset        | UI<br>required | srv<br>KitPreset                     | db                         | Notes           |
| ------------------- | :------------: | ------------------------------------ | -------------------------- | --------------- |
| .key                |       Y        | .Uid                                 | kit_preset.uid             |                 |
| .name               |       Y        | .Name                                | kit_preset.name            |                 |
| .description        |       N        | -                                    | -                          |                 |
| **.channels**       |       Y        | .Channels or LinuxSampler            | preset_channel or none     |                 |
| ..key               |       Y        | .Channels.Key                        | preset_channel.key         |                 |
| ..name              |       Y        | .Channels.Name                       | preset_channel.name        |                 |
| ..type[@sampler]    |       Y        |                                      | -                          | *1              |
| ..type[@instrument] |       Y        | .Channels                            | preset_channel             |                 |
| ..volume            |       Y        | .Channels.Controls[@type==volume]    | preset_channel.controls    | *2              |
| ..volume            |       Y        | .Instruments.Controls[@type==volume] | preset_instrument.controls | *3              |
| ..pan               |       Y        | .Channels.Controls[@type==pan]       | preset_channel.controls    | *2              |
| ..pan               |       Y        | .Instruments.Controls[@type==pan]    | preset_instrument.controls | *3              |
| ..fxs               |                | -                                    | -                          | not implemented |
| **..instruments**   |       Y        | .Instruments                         | preset_instrument          |                 |
| ..key               |       Y        | .Instruments.Id                      | preset_instrument.id       |                 |
| ..name              |       Y        | .Instruments.Name                    | preset_instrument.name     |                 |
| ..volume            |                | .Instruments.Controls[@type==volume] | preset_instrument.controls | *4              |
| ..pan               |                | .Instruments.Controls[@type==pan]    | preset_instrument.controls |                 |
| ..tunes             |                | .Instruments.Controls                | preset_instrument.controls | *5              |
| **..layers**        |                | ..Layers                             | preset_instrument.layers   |                 |
| ..key               |       Y        | ..Layers[@key]                       |                            |                 |
| ..name              |       Y        | ..Layers.Name                        |                            |                 |
| ..volume            |                | ..Layers.Controls[@type==volume]     |                            |                 |
| ..pan               |                | ..Layers.Controls[@type==pan]        |                            |                 |
| ..fxs               |                | -                                    | -                          | not implemented |



*1 LinuxSampler global volume. Doesn't store to db in preset.
*2 In case of many instruments in channel or one instrument, but volume|pan doesn't have midiCC
*3 In case of one instrument in channel and instrument volume|pan has midiCC
*4 Doesn't form UI instrument control in case of one instrument in channel. See *3
*5 Except volume and pan
